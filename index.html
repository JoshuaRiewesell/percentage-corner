<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Percentage Corner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* make the controls card the positioning context */
    #controlsCard { position: relative; }

    /* Info button in top-right of the controls card */
    #info-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border:none;
      background: #ffffff;
      color: #111111;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
        }
    #info-btn svg { display: block; }
    #info-btn:focus { outline: 2px solid rgba(59,130,246,0.25); outline-offset: 2px; }

    /* Modal overlay and content */
    #info-modal {
      position: fixed;
      inset: 0;
      display: none; /* shown via JS */
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      padding: 20px;
    }
    #info-modal[data-open="true"] { display: flex; }

    #info-modal .modal-content {
      background: #fff;
      color: #111;
      max-width: 520px;
      width: 100%;
      border-radius: 8px;
      padding: 18px 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      position: relative;
      font-size: 14px;
      line-height: 1.45;
    }
    #info-modal .modal-content h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    #info-modal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: #333;
    }
    #info-modal .sources { white-space: pre-line; }
  </style>
</head>
<body class="bg-gray-100 p-4 flex flex-col items-center min-h-screen">

<!-- Card für Controls -->
<div id="controlsCard" class="bg-white shadow-lg rounded-xl p-4 w-full max-w-md mb-4">
    <h1 class="text-xl font-semibold mb-4 text-center">Percentage Corner</h1>
    
    <!-- insert info button into the card -->
    <button id="info-btn" aria-label="Open information" title="Information">
      <!-- simple info glyph -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="0" fill="currentColor" opacity="0.12" />
        <path d="M11 10h2v6h-2z" fill="currentColor"/>
        <path d="M11 7h2v2h-2z" fill="currentColor"/>
      </svg>
    </button>

    <div class="flex flex-col sm:flex-row gap-2 mb-4">
        <div class="flex-1">
            <label for="countrySelect" class="block text-sm font-medium mb-1">Land</label>
            <select id="countrySelect" class="w-full border rounded-md p-2 text-sm">
            </select>
        </div>
        <div class="flex-1">
            <label for="yearSelect" class="block text-sm font-medium mb-1">Jahr</label>
            <select id="yearSelect" class="w-full border rounded-md p-2 text-sm">
            </select>
        </div>
    </div>

    <label class="block mb-2 text-sm font-medium">Bild auswählen</label>
    <input type="file" id="fileInput" class="w-full text-sm mb-4">

    <button id="downloadBtn" class="bg-blue-600 text-white p-2 rounded-md w-full font-semibold hidden mb-2 hover:bg-blue-700 transition-colors">Bild herunterladen</button>
</div>

<!-- Bildvorschau (versteckt, wenn leer) -->
<div id="previewContainer" class="bg-white shadow-lg rounded-xl p-4 w-full max-w-md flex justify-center mb-4 hidden">
    <img id="preview" class="rounded-md w-full" alt="Vorschau">
</div>

<!-- Canvas (unsichtbar) -->
<canvas id="canvas" class="hidden"></canvas>

  <!-- Modal markup -->
  <div id="info-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <button class="close-btn" aria-label="Close information">×</button>
      <h2>Sources</h2>
      <div class="sources">- Deutschland 1996-2024 Statistisches Bundesamt
- England and Wales 1968-2021 Office for Health Improvement and Disparities</div>
    </div>
  </div>

<script>
// ---------------------------
// Daten extern laden (data.json)
// ---------------------------
let data = [];

function initWithData(loadedData){
    data = loadedData || [];

    // ---------------------------
    // Dropdowns füllen
    // ---------------------------
    const countrySelect = document.getElementById("countrySelect");
    countrySelect.innerHTML = "";
    data.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.country;
        opt.textContent = d.country;
        countrySelect.appendChild(opt);
    });

    const yearSelect = document.getElementById("yearSelect");
    function populateYears(countryName, preserveYear){
        yearSelect.innerHTML = "";
        const country = data.find(d => d.country === countryName);
        if(!country) return;
        country.years.forEach(y=>{
            const year = Object.keys(y)[0];
            const opt = document.createElement("option");
            opt.value = year;
            opt.textContent = year;
            yearSelect.appendChild(opt);
        });
        // keep previous selection if present, otherwise select latest year
        if(preserveYear && Array.from(yearSelect.options).some(o=>o.value===preserveYear)){
            yearSelect.value = preserveYear;
        } else if(yearSelect.options.length > 0){
            yearSelect.selectedIndex = yearSelect.options.length - 1; // latest year
        }
    }
    if(countrySelect.options.length>0){
        countrySelect.selectedIndex = 0;
        populateYears(countrySelect.value);
    }
    countrySelect.addEventListener("change",()=>{
        const prevYear = yearSelect.value;
        populateYears(countrySelect.value, prevYear);
    });

    // ---------------------------
    // Prozent berechnen
    // ---------------------------
    function getPercentage(countryName, year){
        const country = data.find(d=>d.country===countryName);
        if(!country) return 0;
        const yearObj = country.years.find(y=>Object.keys(y)[0]==year);
        if(!yearObj) return 0;
        const values = yearObj[year];
        if(!values || !('born' in values) || !('aborted' in values)) return 0;
        return (values.aborted / (values.born + values.aborted)) * 100;
    }
    function getText(countryName){
        const country = data.find(d=>d.country===countryName);
        return country ? country.text : "";
    }

    // ---------------------------
    // Bildverarbeitung
    // ---------------------------
    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const previewContainer = document.getElementById("previewContainer");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const downloadBtn = document.getElementById("downloadBtn");

    // store last processed file so we can re-render when country/year change
    let lastFile = null;

    // Hilfsfunktion: Zeige/verstecke die Vorschau nur wenn ein src vorhanden ist
    function updatePreviewVisibility(){
        if(preview.src && preview.src.trim() !== ""){
            previewContainer.classList.remove('hidden');
        } else {
            previewContainer.classList.add('hidden');
        }
    }
    // Initial sicherstellen
    updatePreviewVisibility();

    // Reusable image processing function
    function processFile(file){
        if(!file) return;
        const countrySelectEl = document.getElementById("countrySelect");
        const yearSelectEl = document.getElementById("yearSelect");
        const selectedCountry = countrySelectEl.value;
        const selectedYear = yearSelectEl.value;
        const percent = getPercentage(selectedCountry, selectedYear);
        const overlayText = `${percent.toFixed(2)}% ${getText(selectedCountry)}`;

        const img = new Image();
        const objectURL = URL.createObjectURL(file);
        img.onload = ()=>{
            // ensure canvas matches image
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(img,0,0);

            // Rechteck
            const totalArea = img.width*img.height;
            const rectArea = totalArea*(percent/100);
            const rectSize = Math.sqrt(rectArea);
            const rectWidth = rectSize;
            const rectHeight = rectSize;
            const x = img.width - rectWidth;
            const y = img.height - rectHeight;
            ctx.fillStyle = "black";
            ctx.fillRect(x,y,rectWidth,rectHeight);

            // Text mehrzeilig
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            const fontSize = Math.max(10, rectHeight*0.12);
            ctx.font = `${fontSize}px Arial`;
            const words = overlayText.split(" ");
            const lines = [];
            let line = "";
            words.forEach(w=>{
                const testLine = line + w + " ";
                if(ctx.measureText(testLine).width>rectWidth*0.9){
                    lines.push(line);
                    line=w+" ";
                }else{line=testLine;}
            });
            lines.push(line);
            const lineHeight = fontSize*1.2;
            const startY = y + rectHeight/2 - (lines.length-1)*lineHeight/2;
            lines.forEach((l,i)=>ctx.fillText(l.trim(),x+rectWidth/2,startY+i*lineHeight));

            // Vorschau
            preview.src = canvas.toDataURL("image/png");
            updatePreviewVisibility();

            // Download
            downloadBtn.classList.remove('hidden');
            downloadBtn.onclick=()=>{
                const link = document.createElement("a");
                link.download="bearbeitet.png";
                link.href=canvas.toDataURL("image/png");
                link.click();
            };

            // cleanup URL to avoid memory leak
            URL.revokeObjectURL(objectURL);
        };
        img.onerror = ()=>{
            URL.revokeObjectURL(objectURL);
            console.error('Fehler beim Laden des Bildes.');
        };
        img.src = objectURL;
    }

    fileInput.addEventListener("change", ()=>{
        const file = fileInput.files[0];
        if(!file){
            // kein Bild ausgewählt -> Vorschau und Download-Button verbergen
            preview.src = "";
            updatePreviewVisibility();
            downloadBtn.classList.add('hidden');
            lastFile = null;
            return;
        }
        // remember last file and process it
        lastFile = file;
        processFile(file);
    });

    // re-process when country or year changes if we have a selected file
    const countrySelectEl = document.getElementById("countrySelect");
    const yearSelectEl = document.getElementById("yearSelect");
    countrySelectEl.addEventListener('change', ()=>{
        if(lastFile) processFile(lastFile);
    });
    yearSelectEl.addEventListener('change', ()=>{
        if(lastFile) processFile(lastFile);
    });
}

// Laden der externen JSON-Datei und initialisieren
fetch('data.json', {cache: 'no-cache'})
    .then(r => {
        if(!r.ok) throw new Error('Fehler beim Laden von data.json');
        return r.json();
    })
    .then(d=>initWithData(d))
    .catch(err=>{
        console.error(err);
        alert('Fehler beim Laden der Daten (data.json). Siehe Konsole.');
    });

    // Minimal modal open/close logic
    (function(){
      var infoBtn = document.getElementById('info-btn');
      var modal = document.getElementById('info-modal');
      var closeBtn = modal && modal.querySelector('.close-btn');

      function openModal(){
        if(!modal) return;
        modal.setAttribute('data-open','true');
        modal.setAttribute('aria-hidden','false');
        // focus management: focus close button
        if(closeBtn) closeBtn.focus();
      }
      function closeModal(){
        if(!modal) return;
        modal.removeAttribute('data-open');
        modal.setAttribute('aria-hidden','true');
        if(infoBtn) infoBtn.focus();
      }

      if(infoBtn) infoBtn.addEventListener('click', function(e){ e.preventDefault(); openModal(); });
      if(closeBtn) closeBtn.addEventListener('click', function(e){ e.preventDefault(); closeModal(); });

      // click outside to close
      if(modal) modal.addEventListener('click', function(e){
        if(e.target === modal) closeModal();
      });

      // Escape key to close
      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape' || e.key === 'Esc'){
          if(modal && modal.getAttribute('data-open') === 'true') closeModal();
        }
      });
    })();
  </script>
</body>
</html>